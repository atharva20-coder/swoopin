generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email               String              @unique
  createdAt           DateTime            @default(now())
  openAiKey           String?             @unique
  emailVerified       Boolean             @default(false)
  image               String?
  name                String?
  updatedAt           DateTime            @default(now()) @updatedAt
  adCampaigns         AdCampaign[]
  analytics           Analytics[]
  automations         Automation[]
  brandPartnerships   BrandPartnership[]
  carouselTemplates   CarouselTemplate[]
  contentDrafts       ContentDraft[]
  enterpriseEnquiries EnterpriseEnquiry[]
  instagramEvents     InstagramEvent[]
  integrations        Integrations[]
  notification        Notification[]
  productCatalog      ProductCatalog?
  scheduledPosts      ScheduledPost[]
  subscription        Subscription?
  accounts            Account[]
  onboardingState     OnboardingState?
  organization        Organization?
  sessions            Session[]
  userProfile         UserProfile?

  @@map("user")
}

model Account {
  id                    String    @id @default(uuid())
  userId                String    @db.Uuid
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  idToken               String?
  accessTokenExpiresAt  DateTime?
  scope                 String?
  refreshTokenExpiresAt DateTime?
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("account")
}

model Session {
  id             String   @id @default(uuid())
  userId         String   @db.Uuid
  token          String   @unique
  expiresAt      DateTime
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  impersonatedBy String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Verification {
  id         String    @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@unique([identifier, value])
  @@map("verification")
}

model Subscription {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String?           @unique @db.Uuid
  createdAt         DateTime          @default(now())
  plan              SUBSCRIPTION_PLAN @default(FREE)
  updatedAt         DateTime          @default(now())
  customerId        String?           @unique
  cancelAtPeriodEnd Boolean           @default(false)
  currentPeriodEnd  DateTime?
  User              User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Integrations {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        INTEGRATIONS @default(INSTAGRAM)
  createdAt   DateTime     @default(now())
  userId      String?      @db.Uuid
  token       String       @unique
  expiresAt   DateTime?
  instagramId String?      @unique
  User        User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Automation {
  id                String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String             @default("Untitled")
  createdAt         DateTime           @default(now())
  active            Boolean            @default(false)
  userId            String?            @db.Uuid
  User              User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  carouselTemplates CarouselTemplate[]
  dms               Dms[]
  flowEdges         FlowEdge[]
  flowNodes         FlowNode[]
  keywords          Keyword[]
  listener          Listener?
  posts             Post[]
  scheduledPosts    ScheduledPost[]
  trigger           Trigger[]

  @@index([userId])
  @@index([userId, active])
  @@index([createdAt])
}

model FlowNode {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nodeId       String
  type         String
  subType      String
  label        String
  description  String?
  positionX    Float       @default(0)
  positionY    Float       @default(0)
  config       Json?
  automationId String?     @db.Uuid
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  Automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@unique([automationId, nodeId])
  @@index([automationId])
}

model FlowEdge {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  edgeId       String
  sourceNodeId String
  targetNodeId String
  sourceHandle String?
  targetHandle String?
  automationId String?     @db.Uuid
  createdAt    DateTime    @default(now())
  Automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@unique([automationId, edgeId])
}

model Dms {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  automationId String?     @db.Uuid
  createdAt    DateTime    @default(now())
  senderId     String?
  reciever     String?
  message      String?
  Automation   Automation? @relation(fields: [automationId], references: [id])

  @@index([automationId])
  @@index([senderId])
  @@index([automationId, senderId])
}

model Post {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  postid       String
  caption      String?
  media        String
  mediaType    MEDIATYPE   @default(IMAGE)
  automationId String?     @db.Uuid
  Automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([postid])
}

model Listener {
  id                 String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  automationId       String            @unique @db.Uuid
  listener           LISTENERS         @default(MESSAGE)
  prompt             String
  commentReply       String?
  dmCount            Int               @default(0)
  commentCount       Int               @default(0)
  carouselTemplateId String?           @db.Uuid
  Automation         Automation        @relation(fields: [automationId], references: [id], onDelete: Cascade)
  carouselTemplate   CarouselTemplate? @relation(fields: [carouselTemplateId], references: [id])
}

model Trigger {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type         String
  automationId String?     @db.Uuid
  Automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
}

model Keyword {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  word         String
  automationId String?     @db.Uuid
  Automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@unique([automationId, word])
  @@index([automationId])
  @@index([word])
}

model Notification {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?  @db.Uuid
  isSeen    Boolean  @default(false)
  content   String
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userId, isSeen])
}

model Analytics {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String   @db.Uuid
  date              DateTime @default(now())
  dmCount           Int      @default(0)
  commentCount      Int      @default(0)
  commentReplyCount Int      @default(0)
  postCount         Int      @default(0)
  automationCount   Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model CarouselTemplate {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  automationId String?     @db.Uuid
  userId       String      @db.Uuid
  createdAt    DateTime    @default(now())
  Automation   Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  User         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  elements     Element[]
  listeners    Listener[]
}

model Element {
  id                 String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title              String            @db.VarChar(80)
  subtitle           String?           @db.VarChar(80)
  imageUrl           String?
  carouselTemplateId String?           @db.Uuid
  defaultAction      String?
  order              Int               @default(0)
  buttons            Button[]
  CarouselTemplate   CarouselTemplate? @relation(fields: [carouselTemplateId], references: [id], onDelete: Cascade)
}

model Button {
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type      ButtonType
  title     String     @db.VarChar(20)
  url       String?
  payload   String?
  elementId String?    @db.Uuid
  Element   Element?   @relation(fields: [elementId], references: [id], onDelete: Cascade)
}

model ScheduledPost {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  caption       String?
  mediaUrl      String?
  mediaType     PostMediaType  @default(IMAGE)
  postType      PostType       @default(POST)
  scheduledFor  DateTime
  status        ScheduleStatus @default(SCHEDULED)
  hashtags      String[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  containerId   String?
  igMediaId     String?
  errorMessage  String?
  carouselItems Json?
  altText       String?
  location      String?
  locationId    String?
  music         String?
  taggedUsers   String[]
  collaborators String[]
  trialParams   Json?
  productTags   Json?          // Array of { productId: string, x: number, y: number }
  userId        String?        @db.Uuid
  automationId  String?        @db.Uuid
  Automation    Automation?    @relation(fields: [automationId], references: [id])
  User          User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ContentDraft {
  id        String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title     String?
  caption   String?
  mediaUrl  String?
  mediaType PostMediaType @default(IMAGE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  userId    String?       @db.Uuid
  User      User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EnterpriseEnquiry {
  id                     String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                 String         @db.Uuid
  email                  String
  name                   String?
  company                String?
  teamSize               String?
  useCase                String?
  expectedVolume         String?
  status                 ENQUIRY_STATUS @default(PENDING)
  notes                  String?
  customDmsLimit         Int?
  customAutomationsLimit Int?
  customScheduledLimit   Int?
  customAiLimit          Int?
  dealAmount             Float?
  dealClosed             Boolean        @default(false)
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  paymentLinkExpiresAt   DateTime?
  paymentLinkUrl         String?
  paymentStatus          String?        @default("PENDING")
  phone                  String?
  stripeSessionId        String?
  transactionId          String?
  userType               String?
  isActive               Boolean        @default(false)
  subscriptionEndDate    DateTime?
  User                   User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model UserProfile {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String         @unique @db.Uuid
  displayName       String?
  phoneNumber       String?
  profileType       ProfileType    @default(EXPLORING)
  contentCategories String[]
  platforms         String[]
  primaryPlatform   String?
  followerRange     FollowerRange?
  sellsCoaching     Boolean        @default(false)
  sellsCourses      Boolean        @default(false)
  sellsWorkshops    Boolean        @default(false)
  sellsMemberships  Boolean        @default(false)
  bookingLink       String?
  automationGoals   String[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  bio               String?
  age               Int?
  pronouns          String?
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profile")
}

model Organization {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String        @unique @db.Uuid
  orgType          OrgType
  name             String
  logoUrl          String?
  website          String?
  teamSize         TeamSize?
  industryFocus    String[]
  clientHandles    String[]
  offeringType     OfferingType?
  monthlyDmVolume  String?
  isSupportFocused Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("organization")
}

model OnboardingState {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String    @unique @db.Uuid
  currentStep Int       @default(0)
  isCompleted Boolean   @default(false)
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("onboarding_state")
}

enum SUBSCRIPTION_PLAN {
  PRO
  FREE
  ENTERPRISE
}

enum INTEGRATIONS {
  INSTAGRAM
}

enum MEDIATYPE {
  IMAGE
  VIDEO
  CAROUSEL_ALBUM
}

enum LISTENERS {
  SMARTAI
  MESSAGE
  CAROUSEL
}

enum ButtonType {
  WEB_URL
  POSTBACK
}

enum PostMediaType {
  IMAGE
  VIDEO
  CAROUSEL
}

enum PostType {
  POST
  REEL
  STORY
}

enum ScheduleStatus {
  SCHEDULED
  POSTED
  FAILED
  CANCELLED
}

enum ENQUIRY_STATUS {
  PENDING
  CONTACTED
  NEGOTIATING
  CLOSED_WON
  CLOSED_LOST
}

enum ProfileType {
  CREATOR
  INFLUENCER
  AGENCY
  BRAND
  COACH
  EDUCATOR
  ECOMMERCE
  EXPLORING
}

enum FollowerRange {
  UNDER_1K
  FROM_1K_TO_10K
  FROM_10K_TO_50K
  FROM_50K_TO_100K
  OVER_100K
}

enum OrgType {
  BRAND
  AGENCY
}

enum TeamSize {
  SIZE_1_5
  SIZE_6_10
  SIZE_11_25
  SIZE_25_PLUS
}

enum OfferingType {
  PHYSICAL_PRODUCTS
  DIGITAL_PRODUCTS
  SERVICES
  SUBSCRIPTIONS
}

enum EventStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

model InstagramEvent {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String      @db.Uuid
  eventId     String?     // Meta event ID (null if local only)
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime?
  status      EventStatus @default(SCHEDULED)
  coverImage  String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  User        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startTime])
  @@index([status])
}

enum PartnershipStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PartnershipType {
  BRAND_TO_CREATOR
  CREATOR_TO_BRAND
}

model BrandPartnership {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String            @db.Uuid
  partnerId   String            // Instagram user ID of partner
  partnerName String
  partnerUsername String?
  status      PartnershipStatus @default(PENDING)
  type        PartnershipType
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  User        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([partnerId])
}

enum ProductStatus {
  ACTIVE
  OUT_OF_STOCK
  DISCONTINUED
}

model ProductCatalog {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @unique @db.Uuid
  catalogId String    // Meta catalog ID
  name      String?
  syncedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products  Product[]
}

model Product {
  id         String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  catalogId  String         @db.Uuid
  externalId String         // Meta product ID
  name       String
  price      Decimal        @db.Decimal(10, 2)
  currency   String         @default("USD")
  imageUrl   String?
  status     ProductStatus  @default(ACTIVE)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  catalog    ProductCatalog @relation(fields: [catalogId], references: [id], onDelete: Cascade)

  @@unique([catalogId, externalId])
  @@index([catalogId])
  @@index([status])
}

enum CampaignObjective {
  BRAND_AWARENESS
  REACH
  TRAFFIC
  ENGAGEMENT
  CONVERSIONS
  POST_ENGAGEMENT
}

enum CampaignStatus {
  ACTIVE
  PAUSED
  DELETED
  ARCHIVED
}

model AdCampaign {
  id          String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String             @db.Uuid
  campaignId  String             // Meta campaign ID
  adAccountId String             // Meta ad account ID
  name        String
  objective   CampaignObjective
  status      CampaignStatus     @default(PAUSED)
  budget      Decimal            @db.Decimal(10, 2)
  currency    String             @default("USD")
  startDate   DateTime?
  endDate     DateTime?
  insights    Json?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  User        User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([campaignId])
}
